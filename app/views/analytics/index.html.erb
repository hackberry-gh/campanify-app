<article class="page" id="analytics">
	<section id="map">
		<h2><%= t('html.analytics.map_title') %></h2>
		<div id="map_canvas" style="height:300px;width:100%"></div>
	</section>
	<section id="ranking">
		<h2><%= t('html.analytics.ranking_title') %></h2>
		<div id="ranks"></div>
	</section>
	<section id="graphs">
		<h2><%= t('html.analytics.graphs_title') %></h2>		
		<nav>
			<a href="#hourly"><%= t('html.analytics.hourly') %></a>
			<a href="#daily"><%= t('html.analytics.daily') %></a>
			<a href="#weekly"><%= t('html.analytics.weekly') %></a>
			<a href="#monthly"><%= t('html.analytics.monthly') %></a>
		</nav>	
		<br/><br/>
		<article id="users">
			<span class="linechart hourly"></span>
			<span class="linechart daily"></span>
			<span class="linechart weekly"></span>
			<span class="linechart monthly"></span>
		</article>
		<article id="content_posts">
			<span class="linechart hourly"></span>
			<span class="linechart daily"></span>
			<span class="linechart weekly"></span>
			<span class="linechart monthly"></span>												
		</article>		
	</section>
</article>
<%= javascript_include_tag "jquery.sparkline" %>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
<style>.linechart{display:none;}</style>
<script>
$(document).ready(function(){
	$("#graphs nav a").click(function(){
		var period = $(this).attr('href').replace("#","");
		$(".linechart").hide();
		$(".linechart." + period).show();
		return false;
	});
	$.get("/analytics/map",function(data){
		var markers = [];
		for( var i = 0; i < data['user_counts_by_country'].length; i++){
			var row = data['user_counts_by_country'][i];
			if (row.meta.location !== undefined){
				markers.push({title: row.country + " " + row.user_count, 
														position:{
															latitude: row.meta.location.lat, 
															longitude: row.meta.location.lng
														}});
			}										
		}
		$.campanify.initializeMap(
			{zoom: 1, latitude: 43.68111196292809, longitude: 12.187500000000027},
			markers
		);
	});
	
	$("#ranking #ranks").load("/analytics/ranking");
	
	$.get("/analytics/graphs", function(data){
		
		var periodMaximums = {
			hourly: 25,
			daily: 32,
			weekly: 53,
			monthly: 13
		}
		var periodToName = {
			hourly: "hour",
			daily: "day",
			weekly: "week",
			monthly: "month"			
		}
		var defaultXValues = {
			hourly: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
			daily: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31],
			weekly: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52],
			monthly: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
		}
		
		var values = {};
		
		for( var type in data ){		
			values[type] = {};
			for( var period in data[type] ){
				values[type][period] = period == "total" ? data[type][period] : {x:[], y:[]};
				for( var i in data[type][period]){
					var row = data[type][period][i];
					
					if (period == "total") {
						// do nothing
					} else {
						for(var x = 1; x < periodMaximums[period]; x++){
							values[type][period]["x"].push(x);
							values[type][period]["y"].push( Number(row[periodToName[period]]) == x ? Number(row[type]) : 0 );																			
						}
					}
				}
			}
		}
				
		$.campanify.sparklineValues = values;
		
		var drawSparklines = function () {
			var w = $('.page').width();
			var h = Math.round( w * 4 / 16 ) ;
			var values = $.campanify.sparklineValues;
			for( type in values){
				for( period in values[type]){
					if(period != "total"){
						var xValues,yValues;
						if (values[type][period]["y"].length > 0) {
							yValues = values[type][period]["y"];
							xValues = values[type][period]["x"];					
						}else{
							yValues = [];
							xValues = defaultXValues[period];
							for(var i = 0; i< xValues.length; i++){
								yValues.push(0);
							}
						}
						$("#" + type + ' .linechart.' + period).sparkline(yValues, {xvalues: xValues, width: w + "px", height: h + "px"});
					}

				}
			}
		}
		
		$(window).resize(function(){
			drawSparklines();
		});
		
		drawSparklines();
		
		$("#graphs nav a:first").click();

	});
});
</script>